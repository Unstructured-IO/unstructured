name: Partition Benchmark

# Runs on every PR targeting main.
# Can also be triggered manually to establish or inspect a new baseline.
on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read

env:
  NLTK_DATA: ${{ github.workspace }}/nltk_data
  PYTHON_VERSION: "3.12"
  NUM_ITERATIONS: "1"
  REGRESSION_THRESHOLD: "1.2"
  CACHE_VERSION: "v1"
  RUNTIME_FILE: "scripts/performance/partition-speed-test/partition-runtime.txt"

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/base-cache
        with:
          python-version: ${{ env.PYTHON_VERSION }}

  benchmark:
    name: Measure and compare partition() runtime
    runs-on: ubuntu-latest
    needs: [setup]

    steps:
      - uses: actions/checkout@v4

      - uses: ./.github/actions/base-cache
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libmagic-dev poppler-utils libreoffice
          sudo add-apt-repository -y ppa:alex-p/tesseract-ocr5
          sudo apt-get update
          sudo apt-get install -y tesseract-ocr tesseract-ocr-kor

      - name: Restore HuggingFace model cache
        uses: actions/cache/restore@v4
        with:
          path: ~/.cache/huggingface
          key: hf-models-${{ runner.os }}-${{ env.CACHE_VERSION }}-${{ github.sha }}
          restore-keys: |
            hf-models-${{ runner.os }}-${{ env.CACHE_VERSION }}-
            hf-models-${{ runner.os }}-

      - name: Run partition benchmark
        id: partition
        env:
          NUM_ITERATIONS: ${{ env.NUM_ITERATIONS }}
        run: |
          uv run --no-sync python scripts/performance/benchmark_partition.py

      - name: Save HuggingFace model cache
        uses: actions/cache/save@v4
        with:
          path: ~/.cache/huggingface
          key: hf-models-${{ runner.os }}-${{ env.CACHE_VERSION }}-${{ github.sha }}

      - name: Try downloading previous runtime
        continue-on-error: true
        uses: actions/cache/restore@v4
        with:
          path: ${{ env.RUNTIME_FILE }}
          key: partition-runtime-${{ env.CACHE_VERSION }}-${{ github.sha }}
          restore-keys: |
            partition-runtime-${{ env.CACHE_VERSION }}-

      - name: Compare with previous runtime (if exists)
        id: compare
        run: |
          current_duration=${{ steps.partition.outputs.duration }}
          previous_file="${{ env.RUNTIME_FILE }}"

          if [[ -f "$previous_file" ]]; then
            previous_duration=$(cat "$previous_file")
            echo "Previous duration: ${previous_duration}s"
            echo "Current duration:  ${current_duration}s"
            threshold=$(printf "%.0f" $(echo "$previous_duration * ${{ env.REGRESSION_THRESHOLD }}" | bc -l))
            echo "Threshold (${REGRESSION_THRESHOLD}x): ${threshold}s"
            if [ "$current_duration" -gt "$threshold" ]; then
              echo "RUNTIME_REGRESSED=true" >> $GITHUB_ENV
            else
              echo "RUNTIME_REGRESSED=false" >> $GITHUB_ENV
            fi
          else
            echo "No previous runtime found. Saving current run as baseline."
            echo "RUNTIME_REGRESSED=false" >> $GITHUB_ENV
          fi

      - name: Save current runtime
        run: |
          mkdir -p "$(dirname "${{ env.RUNTIME_FILE }}")"
          echo "${{ steps.partition.outputs.duration }}" > ${{ env.RUNTIME_FILE }}

      - name: Upload current runtime to cache
        uses: actions/cache/save@v4
        with:
          path: ${{ env.RUNTIME_FILE }}
          key: partition-runtime-${{ env.CACHE_VERSION }}-${{ github.sha }}

      - name: Upload benchmark artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ github.sha }}
          path: ${{ env.RUNTIME_FILE }}
          retention-days: 30

      - name: Fail if runtime regressed
        if: env.RUNTIME_REGRESSED == 'true'
        run: |
          echo "FAIL: partition runtime exceeded previous best by more than ${{ env.REGRESSION_THRESHOLD }}x"
          exit 1
