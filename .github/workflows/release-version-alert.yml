name: Release Version Alert

on:
  pull_request:
    branches: [main]
    paths:
      - 'unstructured/__version__.py'  # Specify the path to your __version__.py file

jobs:
  check-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Get PR information
        id: pr-info
        run: |
          PR_NUMBER=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV

      - name: Check versions
        id: check-versions
        run: |
          CHECK_NEW_VERSION_RESPONSE=$(bash scripts/check-new-release-version.sh)
          if [[ "$CHECK_NEW_VERSION_RESPONSE" == "New release version"* ]]; then
            echo "Sending Slack notification..."
            MESSAGE="$CHECK_NEW_VERSION_RESPONSE :rocket: Coming soon in PR: https://github.com/$GITHUB_REPOSITORY/pull/$PR_NUMBER "
            echo "SLACK_MESSAGE=$MESSAGE" >> $GITHUB_ENV
          else
            echo "No new non-dev version found. Skipping Slack notification."
            echo "SKIP_NOTIFICATION=true" >> $GITHUB_ENV  # Set an environment variable to indicate skipping steps
          fi 

      - name: Slack Notification
        if: env.SKIP_NOTIFICATION != 'true'
        uses: slackapi/slack-github-action@v1.24.0
        with:
          channel-id: 'C05RVKRFCCF'
          slack-message: ${{ env.SLACK_MESSAGE }}
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
